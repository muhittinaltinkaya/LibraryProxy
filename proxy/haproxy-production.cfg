global
    daemon
    maxconn 4096
    log stdout local0
    
    # Stats socket for dynamic configuration
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog
    log global
    
    # CORS headers for all responses
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization"
    http-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-response set-header Access-Control-Allow-Credentials "true"

# Stats page
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# Main frontend for proxy and API
frontend libproxy_frontend
    bind *:80
    
    # Handle CORS preflight requests
    acl is_options method OPTIONS
    http-request return status 204 if is_options
    
    # Handle favicon requests
    acl is_favicon path /favicon.ico
    http-request return status 204 if is_favicon
    
    # API requests go to backend
    acl is_api path_beg /api
    use_backend libproxy_backend if is_api
    
    # Health check endpoint
    acl is_health path /health
    http-request return status 200 content-type text/plain string "OK" if is_health
    
    # Default backend for journal proxying - will be populated dynamically
    default_backend libproxy_backend

# Backend for LibProxy API
backend libproxy_backend
    balance roundrobin
    option httpchk GET /api/health
    
    # Add CORS headers
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization"
    http-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-response set-header Access-Control-Allow-Credentials "true"
    
    server backend1 backend:5000 check

# Dynamic journal backends will be added here by the proxy service
# Format: backend journal_<slug>
#         server journal1 <base_url> check
#         http-request set-path %[path,regsub(^/<proxy_path>,)]
