global
    daemon
    log stdout local0
    stats timeout 30s

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option forwardfor
    timeout connect 5000
    timeout client 50000
    timeout server 50000

# Stats page
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# Frontend for LibProxy
frontend libproxy_frontend
    bind *:80
    
    # CORS headers for all responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    
    # Handle preflight OPTIONS requests
    acl is_options method OPTIONS
    http-request return status 200 if is_options
    
    # Handle favicon.ico requests
    acl is_favicon path /favicon.ico
    http-request return status 204 if is_favicon
    
    # Dynamic journal proxy rules
    acl is_nature path_beg /nature
    acl is_science path_beg /science
    acl is_lancet path_beg /lancet
    acl is_jama path_beg /jama
    acl is_auto-test path_beg /auto-test
    acl is_dspace path_beg /dspace
    acl is_test-dynamic path_beg /test-dynamic
    acl is_aaaa path_beg /aaaa
    acl is_test-backend path_beg /test-backend
    use_backend nature_backend if is_nature
    use_backend science_backend if is_science
    use_backend lancet_backend if is_lancet
    use_backend jama_backend if is_jama
    use_backend auto-test_backend if is_auto-test
    use_backend dspace_backend if is_dspace
    use_backend test-dynamic_backend if is_test-dynamic
    use_backend aaaa_backend if is_aaaa
    use_backend test-backend_backend if is_test-backend
    
    default_backend libproxy_backend

# Backend for LibProxy API
backend libproxy_backend
    balance roundrobin
    option httpchk GET /api/health
    http-check expect status 200
    
    # Backend servers
    server libproxy_api backend:5000 check

# Dynamic backend configurations for journals

backend nature_backend
    mode http
    balance roundrobin
    http-request set-path "/" if { path -m str "/nature" }
    http-request set-path %[path,regsub(^/nature/,/)] if { path -m beg "/nature/" }
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    server nature_server www.nature.com:443 ssl verify none
    timeout server 30s

backend science_backend
    mode http
    balance roundrobin
    http-request set-path "/" if { path -m str "/science" }
    http-request set-path %[path,regsub(^/science/,/)] if { path -m beg "/science/" }
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    server science_server www.science.org:443 ssl verify none
    timeout server 30s

backend lancet_backend
    mode http
    balance roundrobin
    http-request set-path "/" if { path -m str "/lancet" }
    http-request set-path %[path,regsub(^/lancet/,/)] if { path -m beg "/lancet/" }
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    server lancet_server www.thelancet.com:443 ssl verify none
    timeout server 30s

backend jama_backend
    mode http
    balance roundrobin
    http-request set-path "/" if { path -m str "/jama" }
    http-request set-path %[path,regsub(^/jama/,/)] if { path -m beg "/jama/" }
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    server jama_server jamanetwork.com:443 ssl verify none
    timeout server 30s

backend auto-test_backend
    mode http
    balance roundrobin
    http-request set-path "/" if { path -m str "/auto-test" }
    http-request set-path %[path,regsub(^/auto-test/,/)] if { path -m beg "/auto-test/" }
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    server auto-test_server httpbin.org:80
    timeout server 30s

backend dspace_backend
    mode http
    balance roundrobin
    http-request set-path "/" if { path -m str "/dspace" }
    http-request set-path %[path,regsub(^/dspace/,/)] if { path -m beg "/dspace/" }
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    server dspace_server dspace.ankara.edu.tr:443 ssl verify none
    timeout server 30s

backend test-dynamic_backend
    mode http
    balance roundrobin
    http-request set-path "/" if { path -m str "/test-dynamic" }
    http-request set-path %[path,regsub(^/test-dynamic/,/)] if { path -m beg "/test-dynamic/" }
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    server test-dynamic_server httpbin.org:443 ssl verify none
    timeout server 30s

backend aaaa_backend
    mode http
    balance roundrobin
    http-request set-path "/" if { path -m str "/aaaa" }
    http-request set-path %[path,regsub(^/aaaa/,/)] if { path -m beg "/aaaa/" }
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    server aaaa_server eksisozluk.com.tr:443 ssl verify none
    timeout server 30s

backend test-backend_backend
    mode http
    balance roundrobin
    http-request set-path "/" if { path -m str "/test-backend" }
    http-request set-path %[path,regsub(^/test-backend/,/)] if { path -m beg "/test-backend/" }
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    server test-backend_server backend:5000
    timeout server 30s
