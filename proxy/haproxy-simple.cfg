global
    daemon
    log stdout local0
    stats timeout 30s

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option forwardfor
    timeout connect 5000
    timeout client 50000
    timeout server 50000

# Stats page
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# Frontend for LibProxy
frontend libproxy_frontend
    bind *:80
    
    # CORS headers for all responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    
    # Handle preflight OPTIONS requests
    acl is_options method OPTIONS
    http-request return status 200 if is_options
    
    # Handle favicon.ico requests
    acl is_favicon path /favicon.ico
    http-request return status 204 if is_favicon
    
    # Dynamic journal proxy rules
    acl is_nature path_beg /nature
    acl is_science path_beg /science
    acl is_lancet path_beg /lancet
    acl is_jama path_beg /jama
    acl is_auto-test path_beg /auto-test
    acl is_dspace path_beg /dspace
    acl is_test-dynamic path_beg /test-dynamic
    acl is_aaaa path_beg /aaaa
    acl is_ankara path_beg /ankara
    use_backend nature_backend if is_nature
    use_backend science_backend if is_science
    use_backend lancet_backend if is_lancet
    use_backend jama_backend if is_jama
    use_backend auto-test_backend if is_auto-test
    use_backend dspace_backend if is_dspace
    use_backend test-dynamic_backend if is_test-dynamic
    use_backend aaaa_backend if is_aaaa
    use_backend ankara_backend if is_ankara
    
    # Frontend routing - for root path and static files
    acl is_frontend hdr(host) -i localhost
    acl is_root_path path -m str /
    acl is_static path_beg /static/
    acl is_config path -m str /config.js
    acl is_favicon path -m str /favicon.ico
    use_backend frontend_backend if is_frontend is_root_path
    use_backend frontend_backend if is_frontend is_static
    use_backend frontend_backend if is_frontend is_config
    use_backend frontend_backend if is_frontend is_favicon
    
    default_backend libproxy_backend

# Backend for LibProxy API
backend libproxy_backend
    balance roundrobin
    option httpchk GET /api/health
    http-check expect status 200
    
    # Backend servers
    server libproxy_api backend:5000 check

# Dynamic backend configurations for journals

backend nature_backend
    mode http
    balance roundrobin
    # Path rewriting for nature proxy
    http-request set-path "/robots.txt" if { path -m str "/nature" }
    http-request set-path %[path,regsub(^/nature/,/)] if { path -m beg "/nature/" }
    
    # Set proper headers for nature.com
    http-request set-header Host "www.nature.com"
    http-request set-header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
    http-request set-header Accept "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
    http-request set-header Accept-Language "en-US,en;q=0.8"
    http-request set-header Accept-Encoding "gzip, deflate"
    http-request set-header Connection "keep-alive"
    http-request set-header Upgrade-Insecure-Requests "1"
    
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    
    server nature_server www.nature.com:443 ssl verify none
    timeout server 30s

backend science_backend
    mode http
    balance roundrobin
    http-request set-path "/" if { path -m str "/science" }
    http-request set-path %[path,regsub(^/science/,/)] if { path -m beg "/science/" }
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    server science_server www.science.org:443 ssl verify none
    timeout server 30s

backend lancet_backend
    mode http
    balance roundrobin
    http-request set-path "/" if { path -m str "/lancet" }
    http-request set-path %[path,regsub(^/lancet/,/)] if { path -m beg "/lancet/" }
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    server lancet_server www.thelancet.com:443 ssl verify none
    timeout server 30s

backend jama_backend
    mode http
    balance roundrobin
    http-request set-path "/" if { path -m str "/jama" }
    http-request set-path %[path,regsub(^/jama/,/)] if { path -m beg "/jama/" }
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    server jama_server jamanetwork.com:443 ssl verify none
    timeout server 30s

backend auto-test_backend
    mode http
    balance roundrobin
    http-request set-path "/" if { path -m str "/auto-test" }
    http-request set-path %[path,regsub(^/auto-test/,/)] if { path -m beg "/auto-test/" }
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    server auto-test_server httpbin.org:443 ssl verify none
    timeout server 30s

backend dspace_backend
    mode http
    balance roundrobin
    http-request set-path "/" if { path -m str "/dspace" }
    http-request set-path %[path,regsub(^/dspace/,/)] if { path -m beg "/dspace/" }
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    server dspace_server dspace.ankara.edu.tr:443 ssl verify none
    timeout server 30s

backend test-dynamic_backend
    mode http
    balance roundrobin
    http-request set-path "/" if { path -m str "/test-dynamic" }
    http-request set-path %[path,regsub(^/test-dynamic/,/)] if { path -m beg "/test-dynamic/" }
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    server test-dynamic_server httpbin.org:443 ssl verify none
    timeout server 30s

backend aaaa_backend
    mode http
    balance roundrobin
    http-request set-path "/" if { path -m str "/aaaa" }
    http-request set-path %[path,regsub(^/aaaa/,/)] if { path -m beg "/aaaa/" }
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    server aaaa_server eksisozluk.com.tr:443 ssl verify none
    timeout server 30s

backend ankara_backend
    mode http
    balance roundrobin
    # Path rewriting for ankara proxy
    http-request set-path "/" if { path -m str "/ankara" }
    http-request set-path %[path,regsub(^/ankara/,/)] if { path -m beg "/ankara/" }
    
    # Set proper headers for ankara.edu.tr
    http-request set-header Host "www.ankara.edu.tr"
    http-request set-header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
    http-request set-header Accept "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
    http-request set-header Accept-Language "tr-TR,tr;q=0.8,en-US;q=0.5,en;q=0.3"
    http-request set-header Accept-Encoding "gzip, deflate"
    http-request set-header Connection "keep-alive"
    http-request set-header Upgrade-Insecure-Requests "1"
    
    # CORS headers for journal responses
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    
    server ankara_server www.ankara.edu.tr:443 ssl verify none
    timeout server 30s

# Frontend backend
backend frontend_backend
    mode http
    balance roundrobin
    option httpchk GET /
    
    # CORS headers for frontend
    http-after-response set-header Access-Control-Allow-Origin "http://localhost:3000"
    http-after-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-after-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    http-after-response set-header Access-Control-Allow-Credentials "true"
    
    server frontend_server frontend:80 check
    timeout server 30s
